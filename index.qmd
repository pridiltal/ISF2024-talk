---
title: "A Backcasting Approach for Anomaly Detection in Time Series Data"
author: "Priyanga Dilini Talagala"
subtitle: "44th International Symposium on Forecasting, Dijon, France"
footer: "Slides created with Quarto, available at prital.netlify.app."
date: 07/01/2024
date-format: long
# logo: images/logo.png
editor: source
execute:
  eval: true
  echo: false
  warning: false
  error: false
  message: false   
format:
  revealjs:
    code-copy: hover
    code-overflow: scroll
    multiplex: false
    embed-resources: true
    controls: auto
    progress: true
    history: true
    hash-type: number    
    slide-number: c
    show-slide-number: all  
    menu:
      side: right
      width: normal
      numbers: true
    # chalkboard:
    #   theme: chalkboard
    #   src: drawings.json
      read-only: false
title-slide-attributes:
  data-background-image: images/logo.png
  data-background-opacity: "0.5"
  data-background-size: 15%
  data-background-position: 98% 98%
  data-background-color: "#d4ca86"
  # data-background-image: grid-worms/bird.webp
  # background-iframe: grid-worms/index.html
css: style.css
preload-iframes: true
---
```{r}
#setup

library(fpp3)
library(patchwork)
library(tidyverse)
library(twosamples)
library(here)
library(denguedatahub)
library(rlang)

library(future)
library(furrr)

library(evd)
library(ismev)
library(plotly)

library(coronavirus)

library(viridis)
```
## Anomalies in Temporal Data

```{r tsout, fig.height= 6}
data <- srilanka_weekly_data |>
  filter(district == "Gampaha") |>
  select(start.date, cases) 
d <- which(data$start.date ==  "2019-12-21" )
data <- data[-d[1],]
data <- data |>
  as_tsibble(index =start.date)

p<- data |>
  autoplot(cases)+
  geom_point(data = data, aes(x = start.date,
                              y=cases))+
  labs(x= "Time", y= "")
 
ggplotly(p)


```


## Dengue Outbreak {background-color="black" background-image="images/Dengue-Cases - Copy.jpg" 
background-size="slide" 
background-position="50% 50%, bottom"}



::: {.footer}
Image Credit: https://www.cdc.gov/dengue/images/socialmedia/LVV7_Aedes_aegypti_Adult_Feeding_2022_029.jpg

:::



## {background-color="black"
background-image="images/france.png" 
background-size="contain"}



## Weekly Dengue Cases in Gampaha District, Sri Lanka



```{r tsout2, fig.width=12}
data <- srilanka_weekly_data |>
  filter(district == "Gampaha") |>
  select(start.date, cases) 
d <- which(data$start.date ==  "2019-12-21" )
data <- data[-d[1],]
data <- data |>
  as_tsibble(index =start.date)

p<- data |>
  autoplot(cases)+
  geom_point(data = data, aes(x = start.date,
                              y=cases))+
  labs(x= "Time", y= "Dengue Cases")

print(p)
```

Data Source: https://denguedatahub.netlify.app/


## Weekly Dengue Cases in Sri Lanka

```{r denguesl, fig.width=14, fig.height = 8}


#  Visualizing colombo district cases
number_ticks <- function(n) {function(limits) pretty(limits, n)}
p<- srilanka_weekly_data %>%  
ggplot(aes(x=start.date, y=cases)) + geom_line()  + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(vars(district), scales = "fixed", ncol=6)+
    labs(x = "Date" , y="Cases")

print(p)
```
## Weekly Dengue Cases in Sri Lanka

```{r denguesl2, fig.width=14, fig.height = 8}


#  Visualizing colombo district cases
number_ticks <- function(n) {function(limits) pretty(limits, n)}
p<- srilanka_weekly_data %>%  
ggplot(aes(x=start.date, y=cases)) + geom_line()  + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(vars(district), scales = "free_y", ncol=6) +
  labs(x = "Date" , y="Cases")

print(p)
```

## {background-color="black" background-image="images/covid.png" 
background-size="slide" }


::: {.footer}
Image Credit: https://www.airforcemedicine.af.mil/portals/1/Images/Graphics/200309-D-HN545-003.png

:::


## Daily COVID-19 Confirmed Cases 

```{r covid, fig.width=14, fig.height = 8}

countries <- c("India" , "Sri Lanka", "Italy", "Brazil",
               "Greece", "US")
data("coronavirus")
Indiadata<- coronavirus |>
 as_tibble() |>
  filter(country %in% countries & type == "confirmed")|>
  select(date, cases, country) |>
  as_tsibble(index = date, key = country)

p <- Indiadata |>
  group_by(country)|>
  ggplot(aes(x= date, y= cases )) +
  geom_line()+
  geom_point()+
  facet_wrap(vars(country), scales = "free_y", ncol=3)
print(p)
```


## 

### Outbreak 

An occurrence of a disease in a specific geographic area that is significantly higher than the established baselines. This increase can be either sudden or gradual.

## {auto-animate=true}

### Outbreak 

An occurrence of a disease in a specific geographic area that is significantly higher than the established baselines. This increase can be either sudden or gradual.


### What is an Anomaly ?

We define an anomaly as an observation that is very unlikely given the backcasted distribution.

An anomaly is an observation that exhibits a significant deviation from the established typical behavior.


## {background-color="black"
background-image="images/Method1.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method2.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method3.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method4.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method5.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method6.png" 
background-size="contain"}



## {background-color="black"
background-image="images/Method7.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method8.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method9.png" 
background-size="contain"}



## {background-color="black"
background-image="images/Method10.png" 
background-size="contain"}


## {background-color="black"
background-image="images/Method11.png" 
background-size="contain"}






## Methodology

- Backcasting is a planning method that starts with defining a desirable future and then works backwards to identify policies and programs that will connect that specified future to the present.


## Methodology

- Backcasting is a planning method that starts with defining a desirable future and then works backwards to identify policies and programs that will connect that specified future to the present.


- This approach allows us to strategically assess how current or future observations fit into historical trends and influences.

## Off-line Phase

- Build a model of a system's typical behaviour


- Use the Exponential Smoothing State Space model with low smoothing parameters for the level and slope, and a high dampening parameter for the slope, emphasizing recent observation influence in backcasting.


## {background-color="white"
background-image="images/typical_model.png" 
background-size="70%"}


## {background-color="white"
background-image="images/fittedvaluesinitial.png" 
background-size="50%"
background-position="50% 80%,center"}

Move the window one step ahead with each new data point 


## {background-color="white"
background-image="images/fittedvalues.png" 
background-size="50%"
background-position="50% 80%,center"}

For each new data subset reinitialize the model state with new data without changing the estimated parameters.


##  {background-color="white"
background-image="images/backcastedval.png" 
background-size="50%"
background-position="50% 80%,center"}


Generating one-step backward projections using a refitted backcasting model.

##  {background-color="white"
background-image="images/errorseriesa.png" 
background-size="50%"
background-position="50% 80%,center"}


Compare the backcasted values with the actual observed values.

## Block Maxima Method for Anomalous Threshold Calculation 

- Select error data from the typical behaviour 

- Divide error data into blocks and extract block maxima and minima

- Apply Generalized Extreme Value distribution to the block maxima and minima to model extreme error values

- Determine the 95th percentile (upper threshold) and 5th percentile (lower threshold) of the GEV distribution


## {background-color="white"
background-image="images/errorseries1.png" 
background-size="60%"
background-position="50% 10%,center"}

